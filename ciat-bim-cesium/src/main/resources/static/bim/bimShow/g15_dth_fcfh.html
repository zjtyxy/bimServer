<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,minimum-scale=1.0,maximum-scale=1.0" />

    <meta name="apple-touch-fullscreen" content="yes" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="x5-fullscreen" content="true" />
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1" />

    <!-- 标题及搜索关键字 -->
    <meta name="keywords" content="中国科学院空天创新研究院" />
    <meta
      name="description"
      content="中国科学院空天创新研究院 三维 地球 模型  gis marsgis 地图离线 地图开发 地图框架 地图外包 框架 开发 外包  地图离线 二维地图 三维地图 全景漫游 地理信息系统 云GIS 三维GIS GIS平台 WebGIS"
    />

    <link rel="shortcut icon" type="image/x-icon" href="http://mars3d.cn/favicon.ico" />
    <title>3dtiles模型矢量叠加单体化 | 中国科学院空天创新研究院</title>

    <!--第三方lib-->
    <script
      type="text/javascript"
      src="../lib/include-lib.js"
      libpath="../lib/"
      include="jquery,font-awesome,bootstrap,layer,haoutil,turf,mars3d"
    ></script>

    <link href="css/style.css" rel="stylesheet" />
  </head>

  <body class="dark">
    <!--加载前进行操作提示，优化用户体验-->
    <div id="mask" class="signmask" onclick="removeMask()"></div>

    <div id="mars3dContainer" class="mars3d-container"></div>

    <script src="./js/common.js"></script>
    <script type="text/javascript">
      'use script' //开发环境建议开启严格模式

      var map
      var geoJsonLayerDTH

      function initMap(options) {
        //合并属性参数，可覆盖config.json中的对应配置
        var mapOptions = mars3d.Util.merge(options, {
          scene: {
            //此处参数会覆盖config.json中的对应配置
            center: {
              y: 31.561722,
              x: 120.848645,
              z: 75.58,
              heading: 52.9,
              pitch: -43.5,
              roll: 0.2,
            },
          },
        })

        //创建三维地球场景
        map = new mars3d.Map('mars3dContainer', mapOptions)

        //添加参考三维模型
        var tilesetLayer = new mars3d.layer.TilesetLayer({
          name: '河道边厂房',
          url: '//data.mars3d.cn/3dtiles/qx-xiaolou/tileset.json',
          position: { alt: 10.1 },
          maximumScreenSpaceError: 1,
          maximumMemoryUsage: 1024,
          show: true,
        })
        map.addLayer(tilesetLayer)

        //创建单体化图层
        geoJsonLayerDTH = new mars3d.layer.GeoJsonLayer({
          name: '分层分户单体化',
          url: '//data.mars3d.cn/file/geojson/dth_fcfh.json',
          onCreateGraphic: createDthGraphic, //自定义解析数据
          dth: {
            type: 'click', //设置这个属性改为单击后高亮,默认为鼠标移入高亮
            color: 'rgba(0,255,0,0.5)',
            buffer: 0.2,
          },
          popup: 'all',
        })
        map.addLayer(geoJsonLayerDTH)
      }

      //添加单体化矢量对象
      function createDthGraphic(graphicOptions) {
        var points = graphicOptions.positions
        var floor = graphicOptions.attr.floor //楼层层高配置信息

        //循环每一层
        var arrGraphic
        for (var j = 0, len = floor.length; j < len; j++) {
          var floorCfg = floor[j]

          var minHight = floorCfg.bottom //当前层的 底部海拔高度
          var maxHight = floorCfg.top //当前层的 顶部海拔高度

          var primitive = new mars3d.graphic.PolygonPrimitive({
            positions: points,
            style: {
              height: minHight,
              extrudedHeight: maxHight,
            },
            attr: floorCfg,
          })
          geoJsonLayerDTH.addGraphic(primitive)
        }
      }
    </script>
  </body>
</html>
