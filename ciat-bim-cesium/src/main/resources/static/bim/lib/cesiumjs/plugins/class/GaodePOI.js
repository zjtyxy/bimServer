/* 2020-2-15 11:51:51 | 版权所有 国信同科 http://marsgis.cn */
function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var r=0;r<t.length;r++){var s=t[r];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function _createClass(e,t,r){return t&&_defineProperties(e.prototype,t),r&&_defineProperties(e,r),e}var GaodePOI=function(){"use strict";function t(e){_classCallCheck(this,t),e=e||{},this._keys=e.key||["027187040fa924e56048468aaa77b62c","2e6ca4aeb6867fb637a5bee8333e5d3a"],this.isFileter=void 0===e.isFileter||e.isFileter,this._key_index=0}return _createClass(t,[{key:"_formatPOIData",value:function(e){for(var t=[],r=0;r<e.length;r++){var s=e[r],o=[];s.location&&0<s.location.length&&(o=mars3d.pointconvert.gcj2wgs(s.location.split(","))),t.push({id:s.id,name:s.name,x:o[0],y:o[1],address:s.address,xzqh:s.pname+s.cityname+s.adname,type:s.type,tel:s.tel||""})}return t}},{key:"query",value:function(e){var t=e.entity,r=this;if(t){if(t.rectangle){var s=mars3d.draw.attr.rectangle.getCoordinates(t);e.points=s,r.queryPolygon(e)}if(t.polygon){s=mars3d.draw.attr.polygon.getCoordinates(t);e.points=s,r.queryPolygon(e)}if(t.ellipse){var o=mars3d.draw.attr.circle.getCoordinates(t)[0],i=t.ellipse.semiMajorAxis.getValue(viewer.clock.currentTime);e.x=o[0],e.y=o[1],e.radius=i,r.queryCircle(e)}}else e.points?r.queryPolygon(e):this.queryText(e)}},{key:"_getKeywords",value:function(e){return haoutil.isutil.isString(e)?e.replaceAll(" ","|").replaceAll(",","|"):haoutil.isutil.isArray(e)?e.join("|"):e}},{key:"autoTip",value:function(r){var e={key:this.key,output:"json"};Cesium.defined(r.city)&&(e.city=r.city),Cesium.defined(r.citylimit)&&(e.citylimit=r.citylimit),r.text?e.keywords=this._getKeywords(r.text):e.types||(e.types="120000|130000|190000"),console.log(e);var s=this;$.ajax({url:"https://restapi.amap.com/v3/assistant/inputtips",type:"GET",dataType:"json",timeout:"5000",contentType:"application/json;utf-8",data:e,success:function(e){if(e.tips){var t=s._formatPOIData(e.tips);r.success&&r.success({allcount:e.count,count:t.length,list:t})}},error:function(e){var t="请求出错("+e.status+")："+e.statusText;r.error&&r.error(t)}})}},{key:"queryText",value:function(s){var e={key:this.key,output:"json",page:s.page||1,offset:s.count||25,types:s.types};Cesium.defined(s.city)&&(e.city=s.city),Cesium.defined(s.citylimit)&&(e.citylimit=s.citylimit),e.citylimit=!0,s.text?e.keywords=this._getKeywords(s.text):e.types||(e.types="120000|130000|190000");var o=this;$.ajax({url:"https://restapi.amap.com/v3/place/text",type:"GET",dataType:"json",timeout:"5000",contentType:"application/json;utf-8",data:e,success:function(e){if("10000"===e.infocode)if(e.pois){var t=o._formatPOIData(e.pois);s.success&&s.success({allcount:e.count,count:t.length,list:t})}else{s.error&&s.error("未查询到相关结果！")}else{var r="POI 请求失败("+e.infocode+")："+e.info;s.error&&s.error(r)}},error:function(e){var t="请求出错("+e.status+")："+e.statusText;s.error&&s.error(t)}})}},{key:"queryCircle",value:function(o){var i={key:this.key,radius:o.radius||3,output:"json",page:o.page||1,offset:o.count||25,types:o.types},e=mars3d.pointconvert.wgs2gcj([o.x,o.y]);i.location=e[0]+","+e[1],o.text?i.keywords=this._getKeywords(o.text):i.types||(i.types="120000|130000|190000");var a=this;$.ajax({url:"https://restapi.amap.com/v3/place/around",type:"GET",dataType:"json",timeout:"5000",contentType:"application/json;utf-8",data:i,success:function(e){if("10000"===e.infocode)if(e.pois){var t,r=a._formatPOIData(e.pois);t=a.isFileter?a._filterPOIData_circle(r,[o.x,o.y],i.radius):r,o.success&&o.success({allcount:e.count,count:t.length,list:t})}else{s="未查询到相关结果！";o.error&&o.error(s)}else{var s="POI 请求失败("+e.infocode+")："+e.info;o.error&&o.error(s)}},error:function(e){var t="请求出错("+e.status+")："+e.statusText;o.error&&o.error(t)}})}},{key:"_filterPOIData_circle",value:function(e,t,r){if(e&&t&&r){t=Cesium.Cartesian3.fromDegrees(t[0],t[1]);for(var s=[],o=0;o<e.length;o++){var i=e[o],a=Cesium.Cartesian3.fromDegrees(i.x,i.y);Cesium.Cartesian3.distance(a,t)<r&&s.push(i)}return s}}},{key:"queryPolygon",value:function(o){var e={key:this.key,output:"json",page:o.page||1,offset:o.count||25,types:o.types},t=o.points,i=[];if(2==t.length){var r=mars3d.pointconvert.wgs2gcj(t[0]),s=mars3d.pointconvert.wgs2gcj(t[1]);e.polygon=r[0]+","+r[1]+"|"+s[0]+","+s[1],i=[t[0],[t[0][0],t[1][1]],t[1],[t[1][0],t[0][1]]]}else{for(var a="",n=(i=t).concat([t[t.length-1]]),c=0;c<n.length;c++){var u=mars3d.pointconvert.wgs2gcj(n[c]);c==n.length-1?a+=u[0]+","+u[1]:a+=u[0]+","+u[1]+"|"}e.polygon=a}o.text?e.keywords=this._getKeywords(o.text):e.types||(e.types="120000|130000|190000");var l=this;$.ajax({url:"https://restapi.amap.com/v3/place/polygon",type:"GET",dataType:"json",timeout:"5000",contentType:"application/json;utf-8",data:e,success:function(e){if("10000"===e.infocode)if(e.pois){var t,r=l._formatPOIData(e.pois);t=l.isFileter?l._filterPOIData_polygon(r,i):r,o.success&&o.success({allcount:e.count,count:t.length,list:t})}else o.error&&o.error("未查询到相关结果！");else{var s="POI 请求失败("+e.infocode+")："+e.info;o.error&&o.error(s)}},error:function(e){var t="请求出错("+e.status+")："+e.statusText;o.error&&o.error(t)}})}},{key:"_filterPOIData_polygon",value:function(e,t){if(e&&t){t=t.concat([t[0]]);for(var r=turf.polygon([t]),s=[],o=0;o<e.length;o++){var i=e[o],a=turf.point([i.x,i.y]);turf.booleanPointInPolygon(a,r)&&s.push(i)}return s}}},{key:"keys",get:function(){return this._keys},set:function(e){this._keys=e}},{key:"key",get:function(){var e=this._key_index++%this._keys.length;return this._keys[e]}}]),t}();